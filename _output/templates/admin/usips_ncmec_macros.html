<xf:macro id="case_list" arg-cases="{{ [] }}">
	<xf:datalist class="dataList">
		<xf:datarow rowtype="header">
			<xf:cell>{{ phrase('title') }}</xf:cell>
			<xf:cell>{{ phrase('user') }}</xf:cell>
			<xf:cell>{{ phrase('date') }}</xf:cell>
			<xf:cell>{{ phrase('status') }}</xf:cell>
			<xf:cell>{{ phrase('usips_ncmec_incidents') }}</xf:cell>
			<xf:cell>{{ phrase('usips_ncmec_reports') }}</xf:cell>
			<xf:cell></xf:cell>
		</xf:datarow>
		<xf:foreach loop="$cases" value="$case">
			<xf:datarow>
				<xf:cell class="dataList-cell--link">
					<a href="{{ link('ncmec-cases/view', $case) }}">
						{{ $case.title ?: phrase('usips_ncmec_untitled_case') }}
					</a>
				</xf:cell>
				<xf:cell>
					<xf:avatar user="$case.User" size="xxs" />
					<xf:username user="$case.User" />
				</xf:cell>
				<xf:cell>
					<xf:date time="$case.created_date" />
				</xf:cell>
				<xf:cell>
					<xf:if is="$case.finalized_on">
						<xf:if is="$case.submitted_on">
							{{ phrase('usips_ncmec_case_submitted') }}
							<xf:else />
							{{ phrase('usips_ncmec_case_finalized') }}
						</xf:if>
						<xf:else />
						{{ phrase('usips_ncmec_draft') }}
					</xf:if>
				</xf:cell>
				<xf:cell>
					<xf:if is="$case.Incidents">
						{$case.Incidents.count()}
						<xf:else />
						0
					</xf:if>
				</xf:cell>
				<xf:cell>
					<xf:if is="$case.Reports">
						{$case.Reports.count()}
						<xf:else />
						0
					</xf:if>
				</xf:cell>
				<xf:if is="!$case.finalized_on">
					<xf:delete href="{{ link('ncmec-cases/delete', $case) }}" />
					<xf:else />
					<xf:cell></xf:cell>
				</xf:if>
			</xf:datarow>
		</xf:foreach>
	</xf:datalist>
</xf:macro>

<xf:macro id="attachment_block" arg-attachments="{{ [] }}" arg-checked="{{ [] }}" arg-incident="{{ false }}">
	<xf:if is="$attachments is not empty">
		<div class="block-body">
			<xf:macro id="attachment_list" arg-attachments="{$attachments}" arg-checked="{$checked}"
				arg-incident="{$incident}" />
		</div>
		<xf:else />
		<div class="block-body block-row">{{ phrase('no_results_found') }}</div>
	</xf:if>
</xf:macro>

<xf:macro id="attachment_list" arg-attachments="{{ [] }}" arg-checked="{{ [] }}" arg-incident="{{ false }}">
	<xf:css src="usips_ncmec.less" />
	<xf:js src="USIPS/NCMEC/attachment_browser.js" />
	<div class="usips-attachments">
		<xf:foreach loop="$attachments" value="$attachment">
			<span
				class="usips-attachment {{ $attachment.IncidentAttachmentData ? 'usips-attachment--inIncident' : '' }}">
				<input type="checkbox" class="usips-attachmentCheckbox"
					id="usips_attachment_{$attachment.attachment_id}" name="attachment_ids[]"
					value="{{ $attachment.attachment_id }}" {{ in_array($attachment.attachment_id, $checked) ? 'checked'
					: '' }} />
				<label class="usips-attachmentLabel" for="usips_attachment_{$attachment.attachment_id}">
					<xf:if is="$attachment.IncidentAttachmentData">
						<span class="usips-attachmentIndicator"
							title="{{ phrase('usips_ncmec_attachment_in_incident') }}" data-xf-init="tooltip">
							<xf:fa icon="fa-exclamation-triangle" />
						</span>
					</xf:if>
					<div class="usips-attachmentOverlay">
						<div class="usips-attachmentInfo">
							<ul>
								<li>{$attachment.content_type}</li>
								<xf:if is="$attachment.content_id == 0">
									<li>{{ phrase('draft') }}</li>
								</xf:if>
								<li>
									<xf:date time="{{ $attachment.Data.upload_date }}" />
								</li>
								<li>{$attachment.filename}</li>
								<xf:if is="$attachment.IncidentAttachmentData">
									<xf:foreach loop="$attachment.IncidentAttachmentData" value="$iad">
										<li class="u-marginTopSmall">
											<span class="usips-attachmentInfo-label">{{ phrase('usips_ncmec_incident')
												}}</span><br />
											<a
												href="{{ link('ncmec-incidents/view', $iad.Incident) }}">{$iad.Incident.title}</a>
										</li>
										<xf:if is="$iad.Incident.Case">
											<li>
												<span class="usips-attachmentInfo-label">{{ phrase('usips_ncmec_case')
													}}</span><br />
												<a
													href="{{ link('ncmec-cases/view', $iad.Incident.Case) }}">{$iad.Incident.Case.title}</a>
											</li>
										</xf:if>
									</xf:foreach>
								</xf:if>
							</ul>
						</div>
					</div>
					<xf:if is="$attachment.has_thumbnail">
						<a href="{{ link('ncmec-attachments/view', $attachment) }}"
							class="usips-attachmentLink usips-attachmentThumbnail"
							style="background-image: url({$attachment.thumbnail_url})" alt="{$attachment.filename}">
						</a>
						<xf:elseif is="$attachment.is_audio" />
						<a href="{{ link('ncmec-attachments/view', $attachment) }}"
							class="usips-attachmentLink usips-attachmentIcon">
							<xf:fa icon="fa-volume fa-4x" />
						</a>
						<xf:elseif is="$attachment.is_video" />
						<a href="{{ link('ncmec-attachments/view', $attachment) }}" class="usips-attachmentLink">
							<video title="{$attachment.filename}" class="usips-attachmentVideo">
								<source src="{$attachment.direct_url}" />
							</video>
						</a>
						<xf:else />
						<a href="{{ link('ncmec-attachments/view', $attachment) }}"
							class="usips-attachmentLink usips-attachmentIcon">
							<xf:fa icon="fa-file fa-4x" />
						</a>
					</xf:if>
				</label>
			</span>
		</xf:foreach>
	</div>
</xf:macro>

<xf:macro id="incident_list" arg-incidents="{{ [] }}" arg-case="{{ null }}">
	<xf:datalist class="dataList">
		<xf:datarow rowtype="header">
			<xf:if is="!$case">
				<xf:cell></xf:cell>
			</xf:if>
			<xf:cell>{{ phrase('title') }}</xf:cell>
			<xf:cell>{{ phrase('user') }}</xf:cell>
			<xf:cell>{{ phrase('date') }}</xf:cell>
			<xf:cell>{{ phrase('status') }}</xf:cell>
			<xf:cell></xf:cell>
			<xf:if is="!$case OR !$case.finalized_on">
				<xf:cell></xf:cell>
			</xf:if>
		</xf:datarow>
		<xf:foreach loop="$incidents" value="$incident">
			<xf:datarow>
				<xf:if is="!$case">
					<xf:if is="$incident.finalized_on">
						<xf:cell></xf:cell>
						<xf:else />
						<xf:toggle name="incident_ids[]" value="{$incident.incident_id}" />
					</xf:if>
				</xf:if>

				<xf:cell class="dataList-cell--link">
					<a href="{{ link('ncmec-incidents/view', $incident) }}">
						{{ $incident.title ?: phrase('usips_ncmec_untitled_incident') }}
					</a>
				</xf:cell>
				<xf:cell>
					<xf:avatar user="$incident.User" size="xxs" />
					<xf:username user="$incident.User" />
				</xf:cell>
				<xf:cell>
					<xf:date time="$incident.created_date" />
				</xf:cell>
				<xf:cell>
					<xf:if is="$incident.finalized_on">
						{{ phrase('usips_ncmec_finalized') }}
						<xf:else />
						{{ phrase('usips_ncmec_draft') }}
					</xf:if>
				</xf:cell>
				<xf:if is="$incident.case_id && !$case">
					<xf:action href="{{ link('ncmec-cases/view', $incident.Case) }}">
						{{ phrase('usips_ncmec_case') }}
					</xf:action>
					<xf:else />
					<xf:cell></xf:cell>
				</xf:if>
				<xf:if is="!$case OR !$case.finalized_on">
					<xf:if is="$case">
						<xf:action href="{{ link('ncmec-incidents/unassign-case', $incident) }}" overlay="true">
							{{ phrase('usips_ncmec_unassign') }}
						</xf:action>
						<xf:elseif is="$incident.case_id" />
						<xf:if is="!$incident.finalized_on">
							<xf:delete href=" {{ link('ncmec-incidents/delete', $incident) }}" />
						</xf:if>
						<xf:else />
						<xf:cell></xf:cell>
					</xf:if>
				</xf:if>
			</xf:datarow>
		</xf:foreach>
	</xf:datalist>
</xf:macro>

<xf:macro id="incident_list_block" arg-incidents="{{ [] }}" arg-header="{{ false }}" arg-nav="{{ true }}"
	arg-total="{{ 0 }}">
	<div class="block">
		<div class="block-container">
			<xf:if is="{$header}">
				<h2 class="block-header">{{ phrase('usips_ncmec_incidents') }}</h2>
			</xf:if>
			<xf:if is="$incidents is not empty">
				<div class="block-body">
					<xf:macro id="incident_list" arg-incidents="{{ $incidents }}" />
				</div>

				<div class="block-footer block-footer--split">
					<span class="block-footer-counter">{{ display_totals($incidents, $total) }}</span>
					<span class="block-footer-select">
						<xf:checkbox standalone="true">
							<xf:option check-all="< .block-container" label="{{ phrase('select_all') }}" />
						</xf:checkbox>
					</span>
					<span class="block-footer-controls">
						<xf:button type="submit" name="assign_case" icon="merge">{{
							phrase('usips_ncmec_assign_case') }}</xf:button>
					</span>
				</div>

				<xf:pagenav page="$page" perpage="$perPage" total="$total" link="ncmec-incidents"
					wrapperclass="block-outer block-outer--after" />
				<xf:else />
				<div class="block-body block-row">{{ phrase('no_results_found') }}</div>
			</xf:if>
		</div>
	</div>
</xf:macro>

<xf:macro id="person_select" arg-name="!" arg-value="!" arg-persons="!" arg-label="" arg-hint="">
	<xf:selectrow name="{$name}" value="{$value}" label="{$label}" hint="{$hint}">
		<xf:option value="0"></xf:option>
		<xf:foreach loop="$persons" value="$person">
			<xf:option value="{$person.person_id}">{$person.display_name}</xf:option>
		</xf:foreach>
	</xf:selectrow>
</xf:macro>

<xf:macro id="report_list" arg-reports="{{ [] }}">
	<xf:datalist class="dataList">
		<xf:datarow rowtype="header">
			<xf:cell></xf:cell>
			<xf:cell>{{ phrase('usips_ncmec_report_id') }}</xf:cell>
			<xf:cell>{{ phrase('created_by') }}</xf:cell>
			<xf:cell>{{ phrase('date') }}</xf:cell>
			<xf:cell>{{ phrase('status') }}</xf:cell>
			<xf:cell></xf:cell>
		</xf:datarow>
		<xf:foreach loop="$reports" value="$report">
			<xf:datarow>
				<xf:cell class="dataList-cell--link">
					<a href="{{ link('ncmec-reports/view', $report) }}">
						{{ phrase('usips_ncmec_report_created_on_x', {'datetime': phrase('date_x_at_time_y', {
						'date': date($report.created_date),
						'time': time($report.created_date)
						}) }) }}
					</a>
				</xf:cell>
				<xf:cell>
					<xf:if is="$report.ncmec_report_id">
						{$report.ncmec_report_id}
						<xf:else />
						<span class="u-muted">{{ phrase('n_a') }}</span>
					</xf:if>
				</xf:cell>
				<xf:cell>
					<xf:avatar user="$report.User" size="xxs" />
					<xf:username user="$report.User" defaultname="{$report.username}" />
				</xf:cell>
				<xf:cell>
					<xf:date time="$report.created_date" />
				</xf:cell>
				<xf:cell>
					<xf:if is="$report.submitted_on">
						{{ phrase('usips_ncmec_finalized') }}
						<xf:else />
						{{ phrase('usips_ncmec_draft') }}
					</xf:if>
				</xf:cell>
				<xf:action href="{{ link('ncmec-cases/view', $report.Case) }}">
					{{ phrase('usips_ncmec_case') }}
				</xf:action>
			</xf:datarow>
		</xf:foreach>
	</xf:datalist>
</xf:macro>

<xf:macro id="report_list_block" arg-reports="{{ [] }}" arg-header="{{ false }}" arg-nav="{{ true }}">
	<div class="block">
		<div class="block-container">
			<xf:if is="{$header}">
				<h2 class="block-header">{{ phrase('usips_ncmec_reports') }}</h2>
			</xf:if>
			<xf:if is="$reports is not empty">
				<div class="block-body">
					<xf:macro id="report_list" arg-reports="{$reports}" />
				</div>

				<xf:pagenav page="$page" perpage="$perPage" total="$total" link="ncmec-reports"
					wrapperclass="block-outer block-outer--after" />
				<xf:else />
				<div class="block-body block-row">{{ phrase('no_results_found') }}</div>
			</xf:if>
		</div>
	</div>
</xf:macro>

<xf:macro id="api_log_list" arg-logs="{{ [] }}">
	<xf:datalist class="dataList">
		<xf:datarow rowtype="header">
			<xf:cell>{{ phrase('date') }}</xf:cell>
			<xf:cell>{{ phrase('usips_ncmec_environment') }}</xf:cell>
			<xf:cell>{{ phrase('usips_ncmec_endpoint') }}</xf:cell>
			<xf:cell>{{ phrase('status') }}</xf:cell>
			<xf:cell>{{ phrase('usips_ncmec_response_code') }}</xf:cell>
			<xf:cell>{{ phrase('usips_ncmec_report') }}</xf:cell>
			<xf:cell>{{ phrase('user') }}</xf:cell>
			<xf:cell></xf:cell>
		</xf:datarow>
		<xf:foreach loop="$logs" value="$log">
			<xf:datarow>
				<xf:cell>
					<xf:date time="{$log.request_date}" />
				</xf:cell>
				<xf:cell>
					<xf:if is="$log.environment == 'test'">
						<span class="label label--orange">{{ phrase('usips_ncmec_test') }}</span>
						<xf:elseif is="$log.environment == 'production'" />
						<span class="label label--red">{{ phrase('usips_ncmec_live') }}</span>
						<xf:else />
						{$log.environment}
					</xf:if>
				</xf:cell>
				<xf:cell>
					<code>{$log.request_method}</code> {$log.request_endpoint}
				</xf:cell>
				<xf:cell>
					<xf:if is="$log.success">
						<span class="label label--green">{{ phrase('success') }}</span>
						<xf:else />
						<span class="label label--red">{{ phrase('error') }}</span>
					</xf:if>
				</xf:cell>
				<xf:cell>
					<xf:if is="$log.response_code">
						{$log.response_code}
						<xf:else />
						<span class="u-muted">{{ phrase('n_a') }}</span>
					</xf:if>
				</xf:cell>
				<xf:cell>
					<xf:if is="$log.Report">
						<a href="{{ link('ncmec-reports/view', $log.Report) }}">
							<xf:if is="$log.Report.Case">
								{$log.Report.Case.title}
								<xf:else />
								{{ phrase('usips_ncmec_report') }} #{$log.report_id}
							</xf:if>
						</a>
						<xf:else />
						<span class="u-muted">{{ phrase('n_a') }}</span>
					</xf:if>
				</xf:cell>
				<xf:cell>
					<xf:if is="$log.User">
						<xf:avatar user="$log.User" size="xxs" />
						<xf:username user="$log.User" />
						<xf:else />
						<span class="u-muted">{{ phrase('n_a') }}</span>
					</xf:if>
				</xf:cell>
				<xf:cell class="dataList-cell--action">
					<a href="{{ link('ncmec-api-logs/view', $log) }}" data-xf-click="overlay">{{ phrase('view') }}</a>
				</xf:cell>
			</xf:datarow>
		</xf:foreach>
	</xf:datalist>
</xf:macro>

<xf:macro id="user_avatar_list" arg-users="{{ [] }}" arg-incident="{{ false }}">
	<div class="user-avatars">
		<xf:foreach loop="$users" value="$user">
			<xf:avatar user="$user.User" size="s"
				href="{{ $incident ? ($incident.finalized_on ? link('users/edit', $user.User) : link('ncmec-incidents/user', $user)) : '' }}" />
		</xf:foreach>
	</div>
</xf:macro>

<xf:macro id="user_avatar_block" arg-users="{{ [] }}" arg-incident="{{ false }}">
	<xf:if is="$users is not empty">
		<div class="block">
			<div class="block-container">
				<h2 class="block-header">{{ phrase('usips_ncmec_users') }}</h2>
				<div class="block-body">
					<xf:macro name="usips_ncmec_macros::user_avatar_list" arg-users="{$users}"
						arg-incident="{$incident}" />
				</div>
			</div>
		</div>
	</xf:if>
</xf:macro>